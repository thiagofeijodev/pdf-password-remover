name: Daily Health Check

on:
  schedule:
    # Runs every day at 9:00 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch: # Allows manual triggering

jobs:
  app-health-check:
    name: Run E2E tests to verify app health
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install üîß
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npm run test:prepare

      - name: Run E2E tests
        env:
          APP_URL: 'https://feijo.dev/pdf-password-remover/'
          CI: 1
        run: npm run test:e2e:ci

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  health-check:
    name: Check if app is up and working
    runs-on: ubuntu-latest

    steps:
      - name: Health Check
        run: |
          APP_URL="https://feijo.dev/pdf-password-remover/"

          echo "üîç Checking if app is accessible..."

          # Check HTTP status and response
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL" || echo "000")

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "‚ùå Health check failed! HTTP Status: $HTTP_STATUS"
            echo "Expected: 200, Got: $HTTP_STATUS"
            exit 1
          fi

          echo "‚úÖ HTTP Status: $HTTP_STATUS"

          # Check if page contains expected content (countdown related)
          echo "üîç Verifying page content..."
          RESPONSE=$(curl -s -L "$APP_URL")

          if [ -z "$RESPONSE" ]; then
            echo "‚ùå Health check failed! Page appears to be empty"
            exit 1
          fi

          # Check for basic HTML structure and React content
          if echo "$RESPONSE" | grep -q "<!doctype html\|<html\|<div\|countdown" -i; then
            echo "‚úÖ Page content verified"
          else
            echo "‚ö†Ô∏è  Warning: Page structure might be unexpected"
          fi

          # Check if main JavaScript bundle is accessible
          echo "üîç Checking JavaScript bundle..."
          if echo "$RESPONSE" | grep -q "\.js\|service-worker" -i; then
            echo "‚úÖ JavaScript assets detected"
          else
            echo "‚ö†Ô∏è  Warning: JavaScript assets might not be loaded"
          fi

          echo ""
          echo "‚úÖ Health check passed! App is up and running."
